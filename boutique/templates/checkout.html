{% extends "base.html" %}

{% block title %}Commande - Ma Boutique{% endblock %}

{% block content %}
<div class="container py-4">
    <h1><i class="fas fa-credit-card"></i> Finaliser la commande</h1>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-map-marker-alt"></i> Adresse de livraison</h5>
                </div>
                <div class="card-body">
                    <form id="checkout-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="first_name" class="form-label">Prénom *</label>
                                <input type="text" class="form-control" id="first_name" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="last_name" class="form-label">Nom *</label>
                                <input type="text" class="form-control" id="last_name" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="address" class="form-label">Adresse *</label>
                            <input type="text" class="form-control" id="address" required>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="postal_code" class="form-label">Code postal *</label>
                                <input type="text" class="form-control" id="postal_code" required>
                            </div>
                            <div class="col-md-8 mb-3">
                                <label for="city" class="form-label">Ville *</label>
                                <input type="text" class="form-control" id="city" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="country" class="form-label">Pays *</label>
                            <select class="form-select" id="country" required>
                                <option value="">Sélectionner un pays</option>
                                <option value="FR">France</option>
                                <option value="BE">Belgique</option>
                                <option value="CH">Suisse</option>
                                <option value="CA">Canada</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="phone" class="form-label">Téléphone *</label>
                            <input type="tel" class="form-control" id="phone" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes (optionnel)</label>
                            <textarea class="form-control" id="notes" rows="3" placeholder="Instructions spéciales pour la livraison..."></textarea>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-credit-card"></i> Mode de paiement</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Mode démo :</strong> Cette boutique est en mode démonstration. 
                        Aucun paiement réel ne sera effectué.
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="payment_method" id="card" value="card" checked>
                        <label class="form-check-label" for="card">
                            <i class="fas fa-credit-card"></i> Carte bancaire
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="payment_method" id="paypal" value="paypal">
                        <label class="form-check-label" for="paypal">
                            <i class="fab fa-paypal"></i> PayPal
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="payment_method" id="bank_transfer" value="bank_transfer">
                        <label class="form-check-label" for="bank_transfer">
                            <i class="fas fa-university"></i> Virement bancaire
                        </label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-shopping-bag"></i> Votre commande</h5>
                </div>
                <div class="card-body">
                    {% for item in cart_items %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <div class="fw-bold">{{ item.product.name }}</div>
                                <small class="text-muted">Quantité: {{ item.quantity }}</small>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">{{ "%.2f"|format(item.total) }} €</div>
                            </div>
                        </div>
                        {% if not loop.last %}
                            <hr class="my-2">
                        {% endif %}
                    {% endfor %}
                    
                    <hr>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Sous-total:</span>
                        <span>{{ "%.2f"|format(total) }} €</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Livraison:</span>
                        <span>
                            {% if total >= 50 %}
                                <span class="text-success">Gratuite</span>
                            {% else %}
                                <span>9.99 €</span>
                            {% endif %}
                        </span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <strong>Total:</strong>
                        <strong>{{ "%.2f"|format(total + (0 if total >= 50 else 9.99)) }} €</strong>
                    </div>
                    
                    <div class="d-grid mt-4">
                        <button class="btn btn-primary btn-lg" onclick="placeOrder()">
                            <i class="fas fa-check"></i> Confirmer la commande
                        </button>
                    </div>
                    
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-lock"></i>
                            Vos données sont protégées par un cryptage SSL
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function placeOrder() {
    // Récupérer les données du formulaire
    const form = document.getElementById('checkout-form');
    const formData = new FormData(form);
    
    // Vérifier que tous les champs requis sont remplis
    const requiredFields = ['first_name', 'last_name', 'address', 'postal_code', 'city', 'country', 'phone', 'email'];
    let isValid = true;
    
    requiredFields.forEach(field => {
        const input = document.getElementById(field);
        if (!input.value.trim()) {
            input.classList.add('is-invalid');
            isValid = false;
        } else {
            input.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        alert('Veuillez remplir tous les champs obligatoires');
        return;
    }
    
    // Construire l'adresse de livraison
    const shippingAddress = `
        ${formData.get('first_name')} ${formData.get('last_name')}
        ${formData.get('address')}
        ${formData.get('postal_code')} ${formData.get('city')}
        ${formData.get('country')}
        Téléphone: ${formData.get('phone')}
        Email: ${formData.get('email')}
        ${formData.get('notes') ? 'Notes: ' + formData.get('notes') : ''}
    `.trim();
    
    // Désactiver le bouton
    const button = event.target;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Traitement...';
    
    // Envoyer la commande
    fetch('/place_order', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            shipping_address: shippingAddress
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Afficher un message de succès
            alert('Commande passée avec succès ! Numéro de commande: ' + data.order_id);
            
            // Rediriger vers la page d'accueil
            window.location.href = '/';
        } else {
            alert('Erreur: ' + data.message);
            button.disabled = false;
            button.innerHTML = '<i class="fas fa-check"></i> Confirmer la commande';
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Une erreur est survenue lors de la commande');
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-check"></i> Confirmer la commande';
    });
}

// Validation en temps réel
document.querySelectorAll('input[required]').forEach(input => {
    input.addEventListener('blur', function() {
        if (this.value.trim()) {
            this.classList.remove('is-invalid');
            this.classList.add('is-valid');
        } else {
            this.classList.remove('is-valid');
            this.classList.add('is-invalid');
        }
    });
});
</script>
{% endblock %}